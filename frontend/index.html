<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journal Article AI Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            display: flex;
            background: #f5f5f5;
        }

        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s;
        }

        .sidebar.collapsed {
            margin-left: -300px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-direction: column;
            gap: 12px;
        }

        .sidebar-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .sidebar-header h2 {
            font-size: 16px;
            font-weight: 600;
        }

        .index-button {
            width: 100%;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }

        .index-button:hover {
            background: #0056b3;
        }

        .index-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .index-button.secondary {
            background: #6c757d;
        }

        .index-button.secondary:hover {
            background: #5a6268;
        }

        .papers-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .paper-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f9f9f9;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            border: 2px solid transparent;
        }

        .paper-item:hover {
            background: #f0f0f0;
        }

        .paper-item.selected {
            background: #e3f2fd;
            border-color: #007bff;
        }

        .paper-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            word-break: break-word;
        }

        .paper-meta {
            font-size: 12px;
            color: #666;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle-sidebar {
            padding: 8px 16px;
            background: #f0f0f0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .toggle-sidebar:hover {
            background: #e0e0e0;
        }

        .stats {
            font-size: 14px;
            color: #666;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
        }

        .message.user {
            align-self: flex-end;
            background: #007bff;
            color: white;
        }

        .message.assistant {
            align-self: flex-start;
            background: #f0f0f0;
            color: #333;
            white-space: pre-wrap;
        }

        .message-content {
            line-height: 1.6;
        }

        .message-content h1,
        .message-content h2,
        .message-content h3 {
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .message-content h1 {
            font-size: 1.5em;
        }

        .message-content h2 {
            font-size: 1.3em;
        }

        .message-content h3 {
            font-size: 1.1em;
        }

        .message-content p {
            margin-bottom: 12px;
        }

        .message-content ul,
        .message-content ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .message-content li {
            margin-bottom: 4px;
        }

        .message-content code {
            background: #e8e8e8;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-content pre {
            background: #2d2d2d;
            color: #f8f8f8;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 12px;
        }

        .message-content pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        .message-content blockquote {
            border-left: 4px solid #007bff;
            padding-left: 12px;
            margin-left: 0;
            margin-bottom: 12px;
            color: #666;
            font-style: italic;
        }

        .message-content strong {
            font-weight: 600;
        }

        .message-content em {
            font-style: italic;
        }

        .message-content a {
            color: #007bff;
            text-decoration: none;
        }

        .message-content a:hover {
            text-decoration: underline;
        }

        .message-sources {
            font-size: 12px;
            margin-top: 8px;
            opacity: 0.8;
        }

        .input-container {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
        }

        .input-box {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
        }

        .input-box:focus {
            outline: none;
            border-color: #007bff;
        }

        .send-button {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .send-button:hover {
            background: #0056b3;
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            padding: 12px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .empty-state {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title-row">
                <h2>Papers</h2>
                <span id="paperCount">0</span>
            </div>
            <button class="index-button" id="indexButton" onclick="indexPapers()">
                üìö Index Papers
            </button>
            <div style="display: flex; gap: 8px; width: 100%;">
                <button class="index-button secondary" id="mindmapButton" onclick="openMindmap()" style="flex: 1;">
                    üß† View Mindmap
                </button>
                <button class="index-button secondary" id="mindmapQueryButton" onclick="editMindmapQuery()" title="Edit mindmap instructions" style="width: 40px; padding: 0; display: flex; align-items: center; justify-content: center;">
                    ‚úèÔ∏è
                </button>
            </div>
        </div>
        <div class="papers-list" id="papersList">
            <div class="empty-state">Click "Index Papers" to load papers from the papers folder</div>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <button class="toggle-sidebar" onclick="toggleSidebar()">‚ò∞ Toggle Sidebar</button>
            <div class="stats">
                <span id="tokenStats">Tokens: 0</span>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="empty-state">Ask a question about the papers</div>
        </div>

        <div class="input-container">
            <textarea 
                class="input-box" 
                id="messageInput" 
                placeholder="Ask a question about the papers..."
                rows="1"
            ></textarea>
            <button class="send-button" id="sendButton" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000/api';
        let sessionId = null;
        let isLoading = false;
        let isIndexing = false;
        let selectedPaperId = null; // Track selected paper ID
        let mindmapQuery = '';

        // Load papers on startup if they were already indexed
        loadPapers();

        // Handle Enter key (Shift+Enter for new line)
        document.getElementById('messageInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        async function indexPapers() {
            if (isIndexing) return;
            
            isIndexing = true;
            const button = document.getElementById('indexButton');
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = '‚è≥ Indexing...';
            
            try {
                const response = await fetch(`${API_URL}/papers/reindex`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to index papers');
                }
                
                const data = await response.json();
                
                // Load the papers list
                await loadPapers();
                
                // Show success message
                button.textContent = `‚úì Indexed ${data.total_papers} papers`;
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            } catch (error) {
                console.error('Error indexing papers:', error);
                button.textContent = '‚úó Error indexing';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            } finally {
                isIndexing = false;
                button.disabled = false;
            }
        }

        function openMindmap() {
            // Open the mindmap visualization in a new tab
            // Pass selected paper ID if one is selected
            let url = '/mindmap';
            if (selectedPaperId) {
                url += `?paper_id=${selectedPaperId}`;
            }
            if (mindmapQuery && mindmapQuery.trim()) {
                const qs = new URLSearchParams();
                qs.set('query', mindmapQuery.trim());
                url += selectedPaperId ? `&${qs.toString()}` : `?${qs.toString()}`;
            }
            window.open(url, '_blank');
        }

        function editMindmapQuery() {
            const baseDefault = 'Organize the content into meaningful themes and subtopics.';
            const scopedDefault = 'Organize this paper\'s content into its main topics and subtopics.';
            const currentDefault = selectedPaperId ? scopedDefault : baseDefault;

            const existing = mindmapQuery && mindmapQuery.trim() ? mindmapQuery : currentDefault;
            const updated = window.prompt('Mindmap instructions (optional):', existing);
            if (updated === null) {
                return; // user cancelled
            }
            const trimmed = updated.trim();
            mindmapQuery = trimmed;
        }

        async function loadPapers() {
            try {
                const response = await fetch(`${API_URL}/papers`);
                const data = await response.json();
                
                const papersList = document.getElementById('papersList');
                const paperCount = document.getElementById('paperCount');
                
                paperCount.textContent = data.total_count;
                
                if (data.papers.length === 0) {
                    papersList.innerHTML = '<div class="empty-state">No papers found</div>';
                    return;
                }
                
                papersList.innerHTML = data.papers.map(paper => {
                    const displayName = paper.canonical_title && paper.canonical_title.trim()
                        ? paper.canonical_title
                        : paper.filename;
                    return `
                    <div class="paper-item" data-paper-id="${paper.id}" onclick="selectPaper('${paper.id}')">
                        <div class="paper-name">${displayName}</div>
                        <div class="paper-meta">${paper.page_count} pages</div>
                    </div>
                `;}).join('');
            } catch (error) {
                console.error('Error loading papers:', error);
                papersList.innerHTML = '<div class="empty-state">Error loading papers</div>';
            }
        }

        function selectPaper(paperId) {
            // Toggle selection
            if (selectedPaperId === paperId) {
                selectedPaperId = null;
                // Remove selection styling from all papers
                document.querySelectorAll('.paper-item').forEach(item => {
                    item.classList.remove('selected');
                });
            } else {
                selectedPaperId = paperId;
                // Update styling
                document.querySelectorAll('.paper-item').forEach(item => {
                    if (item.dataset.paperId === paperId) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                });
            }
        }

        async function sendMessage() {
            if (isLoading) return;
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            isLoading = true;
            document.getElementById('sendButton').disabled = true;
            
            // Add user message to chat
            addMessage(message, 'user');
            input.value = '';
            
            // Show loading indicator and create placeholder for streaming response
            const chatContainer = document.getElementById('chatContainer');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.textContent = 'Thinking...';
            loadingDiv.id = 'loading';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Create assistant message div for streaming
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = 'streaming-message';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.id = 'streaming-content';
            messageDiv.appendChild(contentDiv);
            
            try {
                // Prefer EventSource (GET SSE) for reliable streaming
                const params = new URLSearchParams();
                params.set('message', message);
                if (sessionId) params.set('session_id', sessionId);
                if (selectedPaperId) params.set('paper_id', selectedPaperId);

                const sseUrl = `${API_URL}/chat/stream?${params.toString()}`;

                // Remove loading indicator and add streaming container
                document.getElementById('loading').remove();
                chatContainer.appendChild(messageDiv);

                const es = new EventSource(sseUrl);
                let fullText = '';

                es.onmessage = async (evt) => {
                    try {
                        const data = JSON.parse(evt.data);
                        if (data.type === 'session') {
                            sessionId = data.session_id;
                            return;
                        }
                        if (data.type === 'image') {
                            // Render generated image inline
                            const img = document.createElement('img');
                            img.src = data.data_url;
                            img.alt = 'Generated visualization';
                            img.style.maxWidth = '100%';
                            img.style.borderRadius = '8px';
                            img.style.display = 'block';
                            img.style.marginBottom = '8px';
                            messageDiv.insertBefore(img, contentDiv);
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                            return;
                        }
                        if (data.type === 'chunk') {
                            fullText += data.text;
                            if (typeof marked !== 'undefined') {
                                contentDiv.innerHTML = marked.parse(fullText);
                            } else {
                                contentDiv.textContent = fullText;
                            }
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                            return;
                        }
                        if (data.type === 'done') {
                            const sourcePapers = data.source_papers || [];
                            if (sourcePapers.length > 0) {
                                const sourcesDiv = document.createElement('div');
                                sourcesDiv.className = 'message-sources';
                                sourcesDiv.textContent = `Sources: ${sourcePapers.join(', ')}`;
                                messageDiv.appendChild(sourcesDiv);
                            }
                            if (data.token_usage) {
                                await updateTokenStats();
                            }
                            es.close();
                            // Remove streaming IDs
                            messageDiv.removeAttribute('id');
                            contentDiv.removeAttribute('id');
                        }
                        if (data.type === 'error') {
                            const msg = data.message || 'Server error';
                            // Show a friendlier message for quota/429 errors
                            if (msg.includes('429') || msg.toLowerCase().includes('quota')) {
                                contentDiv.textContent = 'Image generation is currently unavailable due to API quota limits. Try again later or disable images in config.';
                            } else {
                                contentDiv.textContent = 'Error: ' + msg;
                            }
                            es.close();
                            return;
                        }
                    } catch (e) {
                        console.error('SSE parse error', e);
                    }
                };

                es.onerror = (e) => {
                    console.error('SSE error', e);
                    es.close();
                };

            } catch (error) {
                console.error('Error sending message:', error);
                const loadingElem = document.getElementById('loading');
                if (loadingElem) {
                    loadingElem.textContent = 'Error: Could not get response';
                } else {
                    addMessage('Error: Could not get response', 'assistant');
                }
                
                // Remove streaming message if it exists
                const streamingMsg = document.getElementById('streaming-message');
                if (streamingMsg) streamingMsg.remove();
            } finally {
                isLoading = false;
                document.getElementById('sendButton').disabled = false;
                input.focus();
            }
        }

        function addMessage(content, role, sources = []) {
            const chatContainer = document.getElementById('chatContainer');
            
            // Remove empty state if exists
            const emptyState = chatContainer.querySelector('.empty-state');
            if (emptyState) emptyState.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            // Create content div
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // For assistant messages, parse markdown
            if (role === 'assistant' && typeof marked !== 'undefined') {
                // Configure marked for better formatting
                marked.setOptions({
                    breaks: true,
                    gfm: true
                });
                contentDiv.innerHTML = marked.parse(content);
            } else {
                // For user messages, use plain text
                contentDiv.textContent = content;
            }
            
            messageDiv.appendChild(contentDiv);
            
            if (sources && sources.length > 0) {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = 'message-sources';
                sourcesDiv.textContent = `Sources: ${sources.join(', ')}`;
                messageDiv.appendChild(sourcesDiv);
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function updateTokenStats() {
            if (!sessionId) return;
            
            try {
                const response = await fetch(`${API_URL}/tokens/usage/${sessionId}`);
                const data = await response.json();
                document.getElementById('tokenStats').textContent = 
                    `Tokens: ${data.total_tokens.toLocaleString()}`;
            } catch (error) {
                console.error('Error updating token stats:', error);
            }
        }
    </script>
</body>
</html>
